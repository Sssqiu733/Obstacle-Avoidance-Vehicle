#include <reg52.h>				  //单片机头文件
#define uchar unsigned char
#define uint unsigned char
uchar IN,IN0,OUT,OUT0,su,slow;	  //程序参数定义

/******延时子函数******/
void delay(uint z)			   //1MS延时程序
{
	uchar i,j;
	for(i=z;i>0;i--)
		for(j=110;j>0;j--);
}
/****初始化子函数*****/
void init()					//通过定时器模拟PWM输出程序，控制电机的转速
{
	su=0;					
	TMOD=0x01;				//设置单片机定时器工作方式
	EA=1;				    //打开单片机总中断
	ET0=1;					//单片机定时器T0中断允许
	TH0=(65536-50)/256;		//赋初值 高八位
	TL0=(65536-50)%256;		//赋初值 低八位
	TR0=1;					//启动单片机定时器T0
}
/******小车模糊控制子函数*******/
/* 通过不断的实验，把小车的运行状态的可能方式进行模糊集合整理，
把检测模块的检测状态和小车的运行状态之间建立起模糊逻辑关系。
这样当出现A状况的时候，就会通过单片机运算调用对应的a操作，
控制小车前进、后退、左转、右转，以避开障碍物。*/
void jianceIN()
{
	P2=0x81;		                //小车状态转换前先停止500ms	 ，确保电机安全工作
	delay(500);
	switch(IN)	/******红外传感器检测到有障碍物时输出为0******/						      					/*00=停止；01=前进；10=后退；*/
	{		//左中右0000 0xxx	  	                                 输入  12 11 10	   输出    //   L M1 M2 X  R
		case 0x07:{ OUT=0xa9;slow=0;su=0;if(TR0==1)TR0=0;break;}   //111///无 无 无    前进	        1 01 01 00 1
		case 0x06:{ OUT=0x09;slow=500;   if(TR0==0)TR0=1;break;}   //110///无 无 有    小左转	    0 00 01 00 1	 
		case 0x05:{ 
					switch(OUT0){								   //对上一次的转弯状态进行判断
								  case 0x09: { OUT=0xb0;break; }
								  case 0x49: { OUT=0xb0;break; }		    /*检测到前方障碍物，当上一次状态是左转，这次输出右转*/
								  case 0xa0: { OUT=0x49;break; }
								  case 0xb0: { OUT=0x49;break; }			/*检测到前方障碍物，当上一次状态是右转，这次输出左转*/
								  }
							 slow=1000;	 if(TR0==0)TR0=1;break;}   //101///无 有 无    大左转	    0 10 01 00 1
		case 0x04:{ OUT=0x49;slow=1000;  if(TR0==0)TR0=1;break;}   //100///无 有 有    大左转	    0 10 01 00 1
		case 0x03:{ OUT=0xa0;slow=500;   if(TR0==0)TR0=1;break;}   //011///有 无 无    小右转	    1 01 00 00 0
		case 0x02:{ OUT=0xa9;slow=0;su=0;if(TR0==1)TR0=0;break;}   //010///有 无 有    前进	        1 01 01 00 1
		case 0x01:{ OUT=0xb0;slow=1000;  if(TR0==0)TR0=1;break;}   //001///有 有 无    大右转	    1 01 10 00 0
		case 0x00:{ OUT=0xb0;slow=500;   if(TR0==0)TR0=1;break;}   //000///有 有 有    大右转       1 01 10 00 0	  后退0x50
	}
	IN0=IN;						 //记录上次输入信息 
	if(OUT!=0xa9) OUT0=OUT;	 	 //记录上次输出是左右转 
}							    
/*****小车启动子函数******/
void yunxing()
{
	P2=OUT;				         //小车运行  电机驱动程序
}
/*****主函数*****/
void main()
{
	init();						 //系统初始化程序
	while(1)					 //进入避障程序
	{
		if(su==2)				 //减速控制程序
		{
			su=0;				 //PWM周期控制变量
			P2=0x81;			 //控制小车停止
			delay(slow);		 //控制小车停止时间，延时
		}
		IN=P1&0x07;				 //读取红外传感器检测到的状态信息
		if(IN!=IN0)				 //检测红外检测到的开关状态是否发生变化
		{
			delay(500);			 //延时消抖
			if(IN!=IN0)			 //再次判断确认红外检测到的开关状态发生变化
			{
				jianceIN();	     //检测红外检测到的开关状态是否发生变化，当发生变化时候，对新状态进行处理，输出新的小车运行方式。
			}
		}
		yunxing();				 //小车运行
	}
}
/******减速子程序******/
void jiansu() interrupt 1	   //	 50us定时程序
{
	TH0=(65536-500)/256;	   //赋初值 高八位
	TL0=(65536-500)%256;	   //赋初值 低八位
	su++;					   //PWM周期控制变量
}